<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>New Ticket - Service Desk</title>
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <div class="container">
      <nav class="top-nav">
        <a href="/">Dashboard</a> ‚Ä¢ 
        <a href="/tickets">Tickets</a> ‚Ä¢ 
        <a href="/analytics">Analytics</a> ‚Ä¢ 
        <a href="/new-ticket">New Ticket</a> ‚Ä¢ 
        <a href="/settings">Settings</a>
      </nav>

      <h1>üìù Create New Ticket</h1>

      <div class="panel">
        <form id="ticketForm" onsubmit="return createTicket(event)">
          <div class="form-group">
            <label for="sender">Requester Email:</label>
            <input type="email" id="sender" name="sender" placeholder="user@example.com" required>
          </div>

          <div class="form-group">
            <label for="issue">Issue/Subject:</label>
            <input type="text" id="issue" name="issue" placeholder="Describe the issue" required>
          </div>

          <div class="form-group">
            <label for="category">Category:</label>
            <select id="category" name="category">
              {% for cat in teams.keys() %}
              <option value="{{ cat }}">{{ cat }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="priority">Priority:</label>
            <select id="priority" name="priority">
              <option value="Low">Low (Auto-close)</option>
              <option value="Medium" selected>Medium (Open)</option>
              <option value="High">High (Escalate)</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn">Create Ticket</button>
            <a href="/tickets" class="btn btn-secondary">Cancel</a>
          </div>
        </form>

        <div id="result" style="margin-top:20px;"></div>
      </div>

      <div class="panel" style="margin-top:24px;">
        <h3>üìß Simulate Email (for testing)</h3>
        <form id="emailForm" onsubmit="return addEmail(event)">
          <div class="form-group">
            <label for="email_sender">From:</label>
            <input type="email" id="email_sender" name="email_sender" placeholder="sender@example.com" required>
          </div>
          <div class="form-group">
            <label for="email_subject">Subject:</label>
            <input type="text" id="email_subject" name="email_subject" placeholder="Email subject" required>
          </div>
          <div class="form-group">
            <label for="email_body">Body:</label>
            <textarea id="email_body" name="email_body" rows="3" placeholder="Email body content"></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-secondary">Add to emails.txt</button>
          </div>
        </form>
        <div id="emailResult" style="margin-top:10px;"></div>
      </div>
    </div>

    <script>
    function createTicket(e) {
      e.preventDefault();
      const data = {
        sender: document.getElementById('sender').value,
        issue: document.getElementById('issue').value,
        category: document.getElementById('category').value,
        priority: document.getElementById('priority').value
      };
      
      fetch('/api/ticket/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          document.getElementById('result').innerHTML = 
            '<div class="alert-success">‚úì Ticket #' + d.ticket_id + ' created! Status: ' + d.status + 
            ' <a href="/ticket/' + d.ticket_id + '">View</a></div>';
          document.getElementById('ticketForm').reset();
        } else {
          document.getElementById('result').innerHTML = 
            '<div class="alert-error">Error: ' + d.error + '</div>';
        }
      })
      .catch(err => {
        document.getElementById('result').innerHTML = 
          '<div class="alert-error">Error: ' + err + '</div>';
      });
      return false;
    }

    function addEmail(e) {
      e.preventDefault();
      const data = {
        sender: document.getElementById('email_sender').value,
        subject: document.getElementById('email_subject').value,
        body: document.getElementById('email_body').value
      };
      
      fetch('/api/emails/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          document.getElementById('emailResult').innerHTML = 
            '<div class="alert-success">‚úì Email added! <a href="/process">Process now</a></div>';
          document.getElementById('emailForm').reset();
        } else {
          document.getElementById('emailResult').innerHTML = 
            '<div class="alert-error">Error: ' + d.error + '</div>';
        }
      })
      .catch(err => {
        document.getElementById('emailResult').innerHTML = 
          '<div class="alert-error">Error: ' + err + '</div>';
      });
      return false;
    }
    </script>
  </body>
</html>
